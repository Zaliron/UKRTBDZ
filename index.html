<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Домашние задания</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/vue@3.2.47/dist/vue.global.min.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- Подключаем наши модули -->
    <script src="homework.js"></script>
    <script src="homework_archive.js"></script>
    <script src="homework_status.js"></script>

    <style>
        :root {
            --tg-bg-color: #17212b;
            --tg-secondary-bg-color: #232e3c;
            --tg-text-color: #ffffff;
            --tg-hint-color: #7f91a4;
            --tg-link-color: #5d9cec;
            --tg-button-color: #5288c1;
            --tg-button-text-color: #ffffff;
            --tg-section-bg-color: #2b3647;
            --tg-accent-color: #2ea6ff;
        }
        
        body {
            background-color: var(--tg-bg-color);
            color: var(--tg-text-color);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }
        
        .tg-button {
            background-color: var(--tg-button-color);
            color: var(--tg-button-text-color);
            border-radius: 10px;
            padding: 10px 16px;
            font-weight: 500;
            display: inline-block;
            transition: background-color 0.2s;
        }
        
        .tg-button:hover {
            background-color: #3f6a9b;
        }
        
        .subject-item {
            transition: transform 0.2s, background-color 0.2s;
        }
        
        .subject-item:hover {
            transform: translateY(-2px);
            background-color: var(--tg-section-bg-color);
        }
        
        .assignment-card {
            border-left: 4px solid;
            transition: transform 0.2s;
        }
        
        .assignment-card:hover {
            transform: translateX(5px);
        }
        
        .status-badge {
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 10px;
        }
        
        .new-badge {
            background-color: #4a9efb;
        }
        
        .viewed-badge {
            background-color: #6c757d;
        }
        
        .completed-badge {
            background-color: #28a745;
        }
        
        .archived-badge {
            background-color: #6f42c1;
        }
        
        .overdue-badge {
            background-color: #dc3545;
        }
        
        .backdrop {
            background-color: rgba(0, 0, 0, 0.5);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 100;
        }
        
        .modal-content {
            max-height: 90vh;
            overflow-y: auto;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 101;
            width: 90%;
            max-width: 500px;
            background-color: var(--tg-section-bg-color);
            border-radius: 10px;
        }
        
        .file-attachment {
            border-radius: 10px;
            transition: transform 0.2s;
        }
        
        .file-attachment:hover {
            transform: scale(1.02);
        }
        
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }
        
        .custom-scroll::-webkit-scrollbar-track {
            background: var(--tg-secondary-bg-color);
        }
        
        .custom-scroll::-webkit-scrollbar-thumb {
            background: var(--tg-hint-color);
            border-radius: 3px;
        }
        
        /* Tab styles */
        .tab-button {
            position: relative;
            padding: 0.5rem 1rem;
            transition: all 0.3s ease;
        }

        .tab-button.active {
            color: var(--tg-button-color);
        }

        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background-color: var(--tg-button-color);
        }

        /* Animation for new assignment */
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .new-assignment {
            animation: slideUp 0.3s ease-out forwards;
        }
        
        /* Animation for archived assignment */
        @keyframes fadeOut {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.95); }
        }

        .archiving-assignment {
            animation: fadeOut 0.3s ease-out forwards;
        }

        /* Notification styles */
        .notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 102;
            width: 90%;
            max-width: 500px;
            background-color: var(--tg-section-bg-color);
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Modal transitions */
        .modal-enter-active, .modal-leave-active {
            transition: opacity 0.3s ease;
        }

        .modal-enter-from, .modal-leave-to {
            opacity: 0;
        }

        /* WebApp-specific styles */
        .header-fixed {
            position: sticky;
            top: 0;
            z-index: 10;
            padding-top: env(safe-area-inset-top);
        }

        .content-padded {
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* Telegram-like buttons */
        .tg-primary-button {
            background-color: var(--tg-button-color);
            color: var(--tg-text-color);
            border: none;
            border-radius: 10px;
            padding: 10px 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .tg-primary-button:hover {
            background-color: #3f6a9b;
        }

        .tg-secondary-button {
            background-color: var(--tg-secondary-bg-color);
            color: var(--tg-text-color);
            border: none;
            border-radius: 10px;
            padding: 10px 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .tg-secondary-button:hover {
            background-color: #1e2733;
        }

        /* Image preview styles */
        .image-preview-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 8px;
            margin-top: 12px;
        }

        .image-preview {
            position: relative;
            width: 100%;
            padding-bottom: 100%;
            border-radius: 8px;
            overflow: hidden;
            background-color: var(--tg-secondary-bg-color);
        }

        .image-preview img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .image-preview img:hover {
            transform: scale(1.05);
        }

        .image-count-badge {
            position: absolute;
            bottom: 4px;
            right: 4px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .image-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 103;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .image-modal-content {
            max-width: 90%;
            max-height: 90%;
        }

        .image-modal-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            z-index: 1;
        }

        .image-modal-prev {
            left: 20px;
        }

        .image-modal-next {
            right: 20px;
        }

        .image-modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            z-index: 1;
        }

        /* Dark mode aware */
        @media (prefers-color-scheme: dark) {
            :root {
                --tg-bg-color: #18222d;
                --tg-secondary-bg-color: #1e2733;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Rest of the component template -->
    </div>

    <script>
        // Создаем глобальный объект context
        const context = {
            user_data: null
        };
        
        const { createApp, ref, computed, onMounted, nextTick } = Vue;
        
        createApp({
            setup() {
                // View states
                const currentView = ref('main');
                const currentTab = ref('active');
                const isLoading = ref(true);
                const activeModal = ref(null);
                const showNotification = ref(false);
                const confirmationMessage = ref('');
                const confirmationDetails = ref('');
                const pendingConfirmationAction = ref(() => {});
                const notificationMessage = ref('');
                const notificationIcon = ref('');
                const colorScheme = ref('dark');
                
                // Image viewer
                const imageViewer = ref({
                    open: false,
                    images: [],
                    currentIndex: 0
                });
                
                // Telegram WebApp integration
                const WebApp = window.Telegram.WebApp;
                const initData = WebApp.initData || '';
                const initDataUnsafe = WebApp.initDataUnsafe || {};
                
                // Data
                const selectedGroup = ref('');
                const botGroups = ['9ИСП-12К-24', '9КСК-10-24', '9ИСП-111К-24', '9ИКСС-13-24'];
                const ADMIN_KEY = 'admin123'; // Здесь укажите ваш ключ администратора
                const isAdmin = ref(localStorage.getItem('isAdmin') === 'true');
                const adminKeyInput = ref('');
                
                const botSubjects = [
                    { id: 1, name: 'Башкирский язык', emoji: '📚' },
                    { id: 2, name: 'Биология', emoji: '🧬' },
                    { id: 3, name: 'География', emoji: '🌍' },
                    { id: 4, name: 'Иностранный язык', emoji: '🌐' },
                    { id: 5, name: 'Информатика', emoji: '💻' },
                    { id: 6, name: 'История', emoji: '📜' },
                    { id: 7, name: 'Литература', emoji: '📖' },
                    { id: 8, name: 'Математика', emoji: '🔢' },
                    { id: 9, name: 'Обществознание: право', emoji: '⚖️' },
                    { id: 10, name: 'Обществознание: экономика', emoji: '📊' },
                    { id: 11, name: 'Основы безопасности и защиты Родины', emoji: '🛡️' },
                    { id: 12, name: 'Русский язык', emoji: '✍️' },
                    { id: 13, name: 'Физика', emoji: '⚡' },
                    { id: 14, name: 'Физическая культура', emoji: '🏃' },
                    { id: 15, name: 'Химия', emoji: '🧪' }
                ];
                
                const subjects = ref([...botSubjects]);
                
                const newSubject = ref({
                    name: '',
                    emoji: '',
                    group: ''
                });
                
                const currentSubject = ref({});
                const currentAssignment = ref({});
                
                const assignments = ref([
                    {
                        id: 1,
                        subject: 'Математика', 
                        subjectId: 8,
                        group: '9ИСП-12К-24',
                        description: 'Решить задачи №45-50 из учебника, страница 123. Особое внимание уделить задаче №48, так как она будет на контрольной.',
                        status: 'new',
                        assignedDate: new Date(),
                        dueDate: new Date(Date.now() + 86400000 * 3), // 3 days from now
                        files: [
                            { id: 1, name: 'photo1.jpg', size: 1245000, preview: 'https://picsum.photos/200/300?random=1' },
                            { id: 2, name: 'example.png', size: 654321, preview: 'https://picsum.photos/200/300?random=2' },
                            { id: 3, name: 'Дополнительные материалы.pdf', size: 2345678 },
                            { id: 4, name: 'diagram.jpg', size: 456789, preview: 'https://picsum.photos/200/300?random=3' }
                        ],
                        studentFiles: []
                    },
                    {
                        id: 2, 
                        subject: 'Русский язык',
                        subjectId: 12,
                        group: '9ИСП-12К-24',
                        description: 'Написать сочинение на тему "Мое отношение к искусству". Объем - 3 страницы, сдать до следующей среды.',
                        status: 'viewed',
                        assignedDate: new Date(Date.now() - 86400000 * 2),
                        dueDate: new Date(Date.now() + 86400000 * 5),
                        files: [
                            { id: 5, name: 'textbook-page.jpg', size: 765432, preview: 'https://picsum.photos/200/300?random=4' }
                        ],
                        studentFiles: []
                    },
                    {
                        id: 3,
                        subject: 'Физика',
                        subjectId: 13,
                        group: '9ИСП-12К-24',
                        description: 'Подготовить презентацию о законах термодинамики. Минимум 10 слайдов с иллюстрациями.',
                        status: 'completed',
                        assignedDate: new Date(Date.now() - 86400000 * 4),
                        dueDate: new Date(Date.now() - 86400000),
                        files: [
                            { id: 6, name: 'Методичка по термодинамике.pdf', size: 2345678 }
                        ],
                        studentFiles: [
                            { id: 1, name: 'Презентация.pptx', size: 3456789, uploadDate: new Date(Date.now() - 86400000 * 2) }
                        ]
                    },
                    {
                        id: 4,
                        subject: 'История',
                        subjectId: 6,
                        group: '9ИСП-12К-24',
                        description: 'Прочитать главу 5 учебника и подготовить краткий конспект',
                        status: 'new',
                        assignedDate: new Date(),
                        dueDate: null,
                        files: [
                            { id: 7, name: 'historical-image.jpg', size: 1234567, preview: 'https://picsum.photos/200/300?random=5' },
                            { id: 8, name: 'textbook-chapter.pdf', size: 2345678 }
                        ],
                        studentFiles: []
                    },
                    {
                        id: 5,
                        subject: 'Математика',
                        subjectId: 8,
                        group: '9ИСП-12К-24',
                        description: 'Решить контрольную работу из сборника. Вариант 11А.',
                        status: 'archived',
                        assignedDate: new Date(Date.now() - 86400000 * 10),
                        archivedDate: new Date(Date.now() - 86400000 * 7),
                        files: [
                            { id: 9, name: 'Контрольная работа.pdf', size: 765432 },
                            { id: 10, name: 'problem1.jpg', size: 654321, preview: 'https://picsum.photos/200/300?random=6' },
                            { id: 11, name: 'problem2.jpg', size: 543210, preview: 'https://picsum.photos/200/300?random=7' }
                        ],
                        studentFiles: [
                            { id: 2, name: 'Моя контрольная.pdf', size: 654321, uploadDate: new Date(Date.now() - 86400000 * 8) }
                        ]
                    }
                ]);
                
                const newAssignment = ref({
                    subject: '',
                    subjectId: null,
                    group: '',
                    description: '',
                    files: [],
                    dueDate: null
                });
                
                const uploadedFiles = ref([]);
                
                // Добавляем новые элементы
                const newGroupName = ref('');
                
                // Computed properties
                const filteredSubjects = computed(() => {
                    return subjects.value.filter(subj => 
                        subj.group === undefined || 
                        subj.group === '' || 
                        subj.group === selectedGroup.value
                    );
                });
                
                const filteredActiveAssignments = computed(() => {
                    return assignments.value.filter(a => 
                        a.subjectId === currentSubject.value.id && 
                        a.group === selectedGroup.value && 
                        a.status !== 'archived'
                    ).sort((a, b) => new Date(b.assignedDate) - new Date(a.assignedDate));
                });
                
                const filteredArchivedAssignments = computed(() => {
                    return assignments.value.filter(a => 
                        a.subjectId === currentSubject.value.id && 
                        a.group === selectedGroup.value && 
                        a.status === 'archived'
                    ).sort((a, b) => new Date(b.archivedDate) - new Date(a.archivedDate));
                });
                
                // Methods
                const isImageFile = (filename) => {
                    if (!filename) return false;
                    const imgExtensions = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp'];
                    const ext = filename.split('.').pop().toLowerCase();
                    return imgExtensions.includes(ext);
                };
                
                const hasImageAttachments = (assignment) => {
                    return assignment.files.some(file => isImageFile(file.name));
                };
                
                const hasNonImageAttachments = (assignment) => {
                    return assignment.files.some(file => !isImageFile(file.name));
                };
                
                const getImageAttachments = (assignment) => {
                    return assignment.files.filter(file => isImageFile(file.name));
                };
                
                const openImageGallery = (images, startIndex = 0) => {
                    imageViewer.value = {
                        open: true,
                        images: images.map(img => img.preview),
                        currentIndex: startIndex
                    };
                };
                
                const closeImageViewer = () => {
                    imageViewer.value.open = false;
                };
                
                const nextImage = () => {
                    if (imageViewer.value.currentIndex < imageViewer.value.images.length - 1) {
                        imageViewer.value.currentIndex++;
                    }
                };
                
                const prevImage = () => {
                    if (imageViewer.value.currentIndex > 0) {
                        imageViewer.value.currentIndex--;
                    }
                };
                
                const isOverdue = (assignment) => {
                    if (!assignment.dueDate) return false;
                    return new Date(assignment.dueDate) < new Date() && assignment.status !== 'completed';
                };
                
                const formatDate = (date) => {
                    if (!date) return 'Без срока';
                    const d = new Date(date);
                    const options = { day: 'numeric', month: 'long', year: 'numeric' };
                    return d.toLocaleDateString('ru-RU', options);
                };
                
                const formatDateTime = (date) => {
                    if (!date) return '';
                    const d = new Date(date);
                    return d.toLocaleString('ru-RU');
                };
                
                const formatFileSize = (bytes) => {
                    if (bytes === 0) return '0 байт';
                    const sizes = ['байт', 'КБ', 'МБ', 'ГБ'];
                    const i = Math.floor(Math.log(bytes) / Math.log(1024));
                    return parseFloat((bytes / Math.pow(1024, i)).toFixed(2)) + ' ' + sizes[i];
                };
                
                const getPendingCount = (group, subjectId) => {
                    return assignments.value.filter(a => 
                        a.group === group && 
                        a.subjectId === subjectId && 
                        (a.status === 'new' || a.status === 'viewed')
                    ).length;
                };
                
                const getArchivedCount = (group, subjectName) => {
                    return assignments.value.filter(a => 
                        a.group === group && 
                        a.subject === subjectName && 
                        a.status === 'archived'
                    ).length;
                };
                
                // Telegram WebApp methods
                const initTelegramWebApp = () => {
                    try {
                        // Получаем параметры из URL
                        const urlParams = new URLSearchParams(window.location.search);
                        const isAllowed = urlParams.get('allowed') === 'true';
                        const username = urlParams.get('username');
                        
                        // Инициализируем данные пользователя
                        context.user_data = {
                            isAllowed: isAllowed,
                            username: username
                        };
                        
                    if (WebApp) {
                        // Expand app to full viewport
                        WebApp.expand();
                        
                        // Set theme colors
                        colorScheme.value = WebApp.colorScheme || 'dark';
                        WebApp.setBackgroundColor('#17212b');
                        WebApp.setHeaderColor('#2b3647');
                        }
                        
                        // Проверяем группу
                        const savedGroup = localStorage.getItem('selectedGroup');
                        if (savedGroup && botGroups.includes(savedGroup)) {
                            selectedGroup.value = savedGroup;
                        } else if (urlParams.has('group')) {
                            const groupParam = urlParams.get('group');
                            if (botGroups.includes(groupParam)) {
                                selectedGroup.value = groupParam;
                                localStorage.setItem('selectedGroup', groupParam);
                            } else {
                                selectedGroup.value = botGroups[0];
                                localStorage.setItem('selectedGroup', botGroups[0]);
                            }
                        } else {
                            selectedGroup.value = botGroups[0];
                            localStorage.setItem('selectedGroup', botGroups[0]);
                        }
                        
                        // Убираем загрузку после успешной инициализации
                    isLoading.value = false;
                    } catch (error) {
                        console.error('Error initializing WebApp:', error);
                        // В случае ошибки все равно убираем загрузку
                        isLoading.value = false;
                    }
                };
                
                const openFile = (file) => {
                    if (WebApp) {
                        // In Telegram WebApp, we can't open files directly
                        // So we'll just show a notification
                        showNotice('Открытие файлов доступно в основном клиенте Telegram', 'fas fa-info-circle');
                    } else {
                        // Fallback for local development
                        window.open(`#${file.id}`, '_blank');
                    }
                };
                
                const sendDataToBot = (action, data) => {
                    if (WebApp) {
                        WebApp.sendData(JSON.stringify({ action, data }));
                    } else {
                        console.log('Data sent to bot:', { action, data });
                        // Simulate response in development
                        setTimeout(() => {
                            showNotice('Данные отправлены в Telegram бот', 'fas fa-paper-plane');
                        }, 500);
                    }
                };
                
                // Modal methods
                const toggleGroupSelect = () => {
                    activeModal.value = activeModal.value === 'group-select' ? null : 'group-select';
                };
                
                const showAddAssignmentModal = () => {
                    if (!checkPermissions()) return;
                    newAssignment.value.subject = currentSubject.value.name;
                    newAssignment.value.subjectId = currentSubject.value.id;
                    newAssignment.value.group = selectedGroup.value;
                    activeModal.value = 'add-assignment';
                };
                
                const showUploadModal = () => {
                    if (!checkPermissions()) return;
                    uploadedFiles.value = [];
                    activeModal.value = 'file-upload';
                };
                
                const showAddSubjectModal = () => {
                    newSubject.value.group = selectedGroup.value;
                    activeModal.value = 'add-subject';
                };
                
                const showConfirmationModal = (message, details, action) => {
                    confirmationMessage.value = message;
                    confirmationDetails.value = details;
                    pendingConfirmationAction.value = action;
                    activeModal.value = 'confirmation';
                };
                
                const showArchiveConfirmation = () => {
                    showConfirmationModal(
                        'Архивировать задание?',
                        'Задание будет перемещено в архив и скрыто из основного списка.',
                        () => {
                            currentAssignment.value.status = 'archived';
                            currentAssignment.value.archivedDate = new Date();
                            sendDataToBot('archive_assignment', { id: currentAssignment.value.id });
                            currentView.value = 'assignments';
                            showNotice('Задание перемещено в архив', 'fas fa-archive');
                        }
                    );
                };
                
                const executeConfirmationAction = () => {
                    pendingConfirmationAction.value();
                    closeModal();
                };
                
                const closeModal = () => {
                    activeModal.value = null;
                };
                
                // Other methods
                const selectGroup = (group) => {
                    selectedGroup.value = group;
                    localStorage.setItem('selectedGroup', group); // Сохраняем выбранную группу
                    sendDataToBot('select_group', { group });
                    closeModal();
                    showNotice('Группа изменена на ' + group, 'fas fa-check-circle');
                };
                
                const viewAssignments = (subject) => {
                    currentSubject.value = subject;
                    currentView.value = 'assignments';
                    currentTab.value = 'active';
                };
                
                const viewAssignmentDetails = (assignment) => {
                    // Mark as viewed if status is "new"
                    if (assignment.status === 'new') {
                        assignment.status = 'viewed';
                        sendDataToBot('view_assignment', { id: assignment.id });
                    }
                    
                    currentAssignment.value = assignment;
                    currentView.value = 'assignment-details';
                };
                
                const markAsCompleted = () => {
                    currentAssignment.value.status = 'completed';
                    sendDataToBot('complete_assignment', { id: currentAssignment.value.id });
                    showNotice('Задание отмечено как выполненное', 'fas fa-check-circle');
                };
                
                const uncompleteAssignment = () => {
                    currentAssignment.value.status = 'viewed';
                    sendDataToBot('uncomplete_assignment', { id: currentAssignment.value.id });
                    showNotice('Задание возвращено в работу', 'fas fa-undo');
                };
                
                const archiveAssignment = () => {
                    if (!checkPermissions()) return;
                    
                    currentAssignment.value.status = 'archived';
                    currentAssignment.value.archivedDate = new Date();
                    sendDataToBot('archive_assignment', { id: currentAssignment.value.id });
                    currentView.value = 'assignments';
                    showNotice('Задание перемещено в архив', 'fas fa-archive');
                };
                
                const unarchiveAssignment = () => {
                    currentAssignment.value.status = 'viewed';
                    sendDataToBot('unarchive_assignment', { id: currentAssignment.value.id });
                    currentView.value = 'assignments';
                    showNotice('Задание восстановлено из архива', 'fas fa-box-open');
                };
                
                const triggerFileInput = () => {
                    const fileInput = document.querySelector('input[type="file"]');
                    if (fileInput) fileInput.click();
                };
                
                const handleFileUpload = (event) => {
                    const files = Array.from(event.target.files || []);
                    files.forEach(file => {
                        const reader = new FileReader();
                        if (isImageFile(file.name)) {
                            reader.onload = (e) => {
                                uploadedFiles.value.push({
                                    id: Date.now() + Math.random().toString(36).substring(2),
                                    name: file.name,
                                    size: file.size,
                                    preview: e.target.result
                                });
                            };
                            reader.readAsDataURL(file);
                        } else {
                            uploadedFiles.value.push({
                                id: Date.now() + Math.random().toString(36).substring(2),
                                name: file.name,
                                size: file.size
                            });
                        }
                    });
                };
                
                const removeFile = (index) => {
                    uploadedFiles.value.splice(index, 1);
                };
                
                const submitSolution = () => {
                    if (!checkPermissions()) return;
                    
                    // Add uploaded files to the assignment
                    uploadedFiles.value.forEach(file => {
                        currentAssignment.value.studentFiles.push({
                            ...file,
                            uploadDate: new Date()
                        });
                    });
                    
                    sendDataToBot('upload_solution', {
                        assignmentId: currentAssignment.value.id,
                        files: uploadedFiles.value
                    });
                    
                    uploadedFiles.value = [];
                    closeModal();
                    showNotice('Решение успешно загружено', 'fas fa-check-circle');
                };
                
                const createAssignment = async () => {
                    if (!checkPermissions()) return;
                    
                    const currentFiles = [...newAssignment.value.files];
                    
                    const newAssignmentObj = {
                        id: Date.now(),
                        subject: currentSubject.value.name,
                        subjectId: currentSubject.value.id,
                        group: selectedGroup.value,
                        description: newAssignment.value.description,
                        status: 'new',
                        assignedDate: new Date(),
                        dueDate: newAssignment.value.dueDate ? new Date(newAssignment.value.dueDate) : null,
                        files: currentFiles,
                        studentFiles: []
                    };
                    
                    assignments.value.unshift(newAssignmentObj);
                    sendDataToBot('create_assignment', newAssignmentObj);
                    
                    // Сбрасываем все значения формы
                    Object.assign(newAssignment.value, {
                        subject: '',
                        subjectId: null,
                        group: '',
                        description: '',
                        files: [],
                        dueDate: null
                    });
                    
                    // Форсируем обновление DOM перед закрытием
                    await nextTick();
                    
                    // Закрываем модальное окно напрямую
                    const modalElement = document.querySelector('.modal-content');
                    if (modalElement) {
                        modalElement.style.display = 'none';
                    }
                    
                    activeModal.value = null;
                    
                    // Показываем уведомление
                    showNotice('Новое задание добавлено', 'fas fa-check-circle');
                };
                
                const triggerAssignmentFileInput = () => {
                    const fileInput = document.querySelector('input[type="file"]');
                    if (fileInput) fileInput.click();
                };
                
                const handleAssignmentFileUpload = (event) => {
                    const files = Array.from(event.target.files || []);
                    const promises = files.map(file => {
                        return new Promise((resolve) => {
                            if (isImageFile(file.name)) {
                                const reader = new FileReader();
                                reader.onload = (e) => {
                                    resolve({
                                        id: Date.now() + Math.random().toString(36).substring(2),
                                        name: file.name,
                                        size: file.size,
                                        preview: e.target.result
                                    });
                                };
                                reader.readAsDataURL(file);
                            } else {
                                resolve({
                                    id: Date.now() + Math.random().toString(36).substring(2),
                                    name: file.name,
                                    size: file.size
                                });
                            }
                        });
                    });

                    Promise.all(promises).then(files => {
                        newAssignment.value.files.push(...files);
                    });
                };
                
                const removeAssignmentFile = (index) => {
                    newAssignment.value.files.splice(index, 1);
                };
                
                const addSubject = () => {
                    const newSubjectObj = {
                        id: Date.now(),
                        name: newSubject.value.name,
                        emoji: newSubject.value.emoji,
                        group: newSubject.value.group || selectedGroup.value
                    };
                    
                    subjects.value.push(newSubjectObj);
                    
                    // Reset form
                    newSubject.value = {
                        name: '',
                        emoji: '',
                        group: ''
                    };
                    
                    sendDataToBot('add_subject', newSubjectObj);
                    
                    closeModal();
                    showNotice('Новый предмет добавлен', 'fas fa-check-circle');
                };
                
                const showNotice = (message, icon) => {
                    notificationMessage.value = message;
                    notificationIcon.value = icon;
                    showNotification.value = true;
                    
                    setTimeout(() => {
                        showNotification.value = false;
                    }, 3000);
                };
                
                const viewArchivedSubjects = () => {
                    showNotice('Функция архива предметов в разработке', 'fas fa-cogs');
                };
                
                // Также добавьте метод для принудительного закрытия модального окна
                const forceCloseModal = () => {
                    activeModal.value = null;
                    const modalElement = document.querySelector('.modal-content');
                    if (modalElement) {
                        modalElement.style.display = 'none';
                    }
                };
                
                // Добавляем метод для проверки прав
                const checkPermissions = () => {
                    if (!isAdmin.value) {
                        showNotice('У вас нет прав для добавления заданий', 'fas fa-exclamation-circle');
                        return false;
                    }
                    return true;
                };
                
                // Admin methods
                const showAdminKeyModal = () => {
                    activeModal.value = 'admin-key';
                };

                const submitAdminKey = () => {
                    if (adminKeyInput.value === ADMIN_KEY) {
                        isAdmin.value = true;
                        localStorage.setItem('isAdmin', 'true');
                        showNotice('Права администратора получены', 'fas fa-check-circle');
                        closeModal();
                    } else {
                        showNotice('Неверный ключ администратора', 'fas fa-exclamation-circle');
                    }
                    adminKeyInput.value = '';
                };

                const removeAdminRights = () => {
                    isAdmin.value = false;
                    localStorage.removeItem('isAdmin');
                    showNotice('Права администратора удалены', 'fas fa-user-slash');
                    closeModal();
                };
                
                // Добавляем новые методы
                const showManageGroupsModal = () => {
                    if (!isAdmin.value) {
                        showNotice('У вас нет прав для управления группами', 'fas fa-exclamation-circle');
                        return;
                    }
                    activeModal.value = 'manage-groups';
                };

                const addNewGroup = () => {
                    if (!newGroupName.value.trim()) return;
                    
                    if (botGroups.includes(newGroupName.value.trim())) {
                        showNotice('Такая группа уже существует', 'fas fa-exclamation-circle');
                        return;
                    }

                    botGroups.push(newGroupName.value.trim());
                    showNotice('Группа успешно добавлена', 'fas fa-check-circle');
                    newGroupName.value = '';
                };

                const confirmDeleteGroup = (group) => {
                    showConfirmationModal(
                        'Удалить группу?',
                        `Вы уверены, что хотите удалить группу "${group}"? Все данные группы будут потеряны.`,
                        () => deleteGroup(group)
                    );
                };

                const deleteGroup = (group) => {
                    const groups = botGroups.filter(g => g !== group);
                    botGroups.value = groups;
                    
                    // Если удаляем текущую группу, переключаемся на первую доступную
                    if (selectedGroup.value === group && groups.length > 0) {
                        selectedGroup.value = groups[0];
                    }
                    
                    showNotice('Группа успешно удалена', 'fas fa-check-circle');
                };
                
                // Initialize
                onMounted(() => {
                    initTelegramWebApp();
                });
                
                // Также нужно скрыть кнопки добавления/редактирования для пользователей без прав
                const showActionButtons = computed(() => {
                    return isAdmin.value === true;
                });
                
                return {
                    // States
                    currentView,
                    currentTab,
                    isLoading,
                    activeModal,
                    showNotification,
                    confirmationMessage,
                    confirmationDetails,
                    notificationMessage,
                    notificationIcon,
                    imageViewer,
                    isAdmin,
                    adminKeyInput,
                    
                    // Data
                    selectedGroup,
                    botGroups,
                    subjects,
                    filteredSubjects,
                    newSubject,
                    currentSubject,
                    currentAssignment,
                    assignments,
                    newAssignment,
                    uploadedFiles,
                    newGroupName,
                    
                    // Computed properties
                    filteredActiveAssignments,
                    filteredArchivedAssignments,
                    showActionButtons,
                    
                    // Methods
                    isOverdue,
                    formatDate,
                    formatDateTime,
                    formatFileSize,
                    getPendingCount,
                    getArchivedCount,
                    toggleGroupSelect,
                    selectGroup,
                    viewAssignments,
                    viewAssignmentDetails,
                    markAsCompleted,
                    uncompleteAssignment,
                    archiveAssignment,
                    unarchiveAssignment,
                    openFile,
                    triggerFileInput,
                    handleFileUpload,
                    removeFile,
                    submitSolution,
                    createAssignment,
                    triggerAssignmentFileInput,
                    handleAssignmentFileUpload,
                    removeAssignmentFile,
                    showAddSubjectModal,
                    addSubject,
                    viewArchivedSubjects,
                    showConfirmationModal,
                    showArchiveConfirmation,
                    executeConfirmationAction,
                    closeModal,
                    showAddAssignmentModal,
                    showUploadModal,
                    isImageFile,
                    hasImageAttachments,
                    hasNonImageAttachments,
                    getImageAttachments,
                    openImageGallery,
                    closeImageViewer,
                    nextImage,
                    prevImage,
                    forceCloseModal,
                    checkPermissions,
                    showAdminKeyModal,
                    submitAdminKey,
                    removeAdminRights,
                    showManageGroupsModal,
                    addNewGroup,
                    confirmDeleteGroup
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
