<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/vue@3.2.47/dist/vue.global.min.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –Ω–∞—à–∏ –º–æ–¥—É–ª–∏ -->
    <script src="homework.js"></script>
    <script src="homework_archive.js"></script>
    <script src="homework_status.js"></script>

    <style>
        :root {
            --tg-bg-color: #17212b;
            --tg-secondary-bg-color: #232e3c;
            --tg-text-color: #ffffff;
            --tg-hint-color: #7f91a4;
            --tg-link-color: #5d9cec;
            --tg-button-color: #5288c1;
            --tg-button-text-color: #ffffff;
            --tg-section-bg-color: #2b3647;
            --tg-accent-color: #2ea6ff;
        }
        
        body {
            background-color: var(--tg-bg-color);
            color: var(--tg-text-color);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }
        
        .tg-button {
            background-color: var(--tg-button-color);
            color: var(--tg-button-text-color);
            border-radius: 10px;
            padding: 10px 16px;
            font-weight: 500;
            display: inline-block;
            transition: background-color 0.2s;
        }
        
        .tg-button:hover {
            background-color: #3f6a9b;
        }
        
        .subject-item {
            transition: transform 0.2s, background-color 0.2s;
        }
        
        .subject-item:hover {
            transform: translateY(-2px);
            background-color: var(--tg-section-bg-color);
        }
        
        .assignment-card {
            border-left: 4px solid;
            transition: transform 0.2s;
        }
        
        .assignment-card:hover {
            transform: translateX(5px);
        }
        
        .status-badge {
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 10px;
        }
        
        .new-badge {
            background-color: #4a9efb;
        }
        
        .viewed-badge {
            background-color: #6c757d;
        }
        
        .completed-badge {
            background-color: #28a745;
        }
        
        .archived-badge {
            background-color: #6f42c1;
        }
        
        .overdue-badge {
            background-color: #dc3545;
        }
        
        .backdrop {
            background-color: rgba(0, 0, 0, 0.5);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 100;
        }
        
        .modal-content {
            max-height: 90vh;
            overflow-y: auto;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 101;
            width: 90%;
            max-width: 500px;
            background-color: var(--tg-section-bg-color);
            border-radius: 10px;
        }
        
        .file-attachment {
            border-radius: 10px;
            transition: transform 0.2s;
        }
        
        .file-attachment:hover {
            transform: scale(1.02);
        }
        
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }
        
        .custom-scroll::-webkit-scrollbar-track {
            background: var(--tg-secondary-bg-color);
        }
        
        .custom-scroll::-webkit-scrollbar-thumb {
            background: var(--tg-hint-color);
            border-radius: 3px;
        }
        
        /* Tab styles */
        .tab-button {
            position: relative;
            padding: 0.5rem 1rem;
            transition: all 0.3s ease;
        }

        .tab-button.active {
            color: var(--tg-button-color);
        }

        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background-color: var(--tg-button-color);
        }

        /* Animation for new assignment */
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .new-assignment {
            animation: slideUp 0.3s ease-out forwards;
        }
        
        /* Animation for archived assignment */
        @keyframes fadeOut {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.95); }
        }

        .archiving-assignment {
            animation: fadeOut 0.3s ease-out forwards;
        }

        /* Notification styles */
        .notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 102;
            width: 90%;
            max-width: 500px;
            background-color: var(--tg-section-bg-color);
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Modal transitions */
        .modal-enter-active, .modal-leave-active {
            transition: opacity 0.3s ease;
        }

        .modal-enter-from, .modal-leave-to {
            opacity: 0;
        }

        /* WebApp-specific styles */
        .header-fixed {
            position: sticky;
            top: 0;
            z-index: 10;
            padding-top: env(safe-area-inset-top);
        }

        .content-padded {
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* Telegram-like buttons */
        .tg-primary-button {
            background-color: var(--tg-button-color);
            color: var(--tg-text-color);
            border: none;
            border-radius: 10px;
            padding: 10px 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .tg-primary-button:hover {
            background-color: #3f6a9b;
        }

        .tg-secondary-button {
            background-color: var(--tg-secondary-bg-color);
            color: var(--tg-text-color);
            border: none;
            border-radius: 10px;
            padding: 10px 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .tg-secondary-button:hover {
            background-color: #1e2733;
        }

        /* Image preview styles */
        .image-preview-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 8px;
            margin-top: 12px;
        }

        .image-preview {
            position: relative;
            width: 100%;
            padding-bottom: 100%;
            border-radius: 8px;
            overflow: hidden;
            background-color: var(--tg-secondary-bg-color);
        }

        .image-preview img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .image-preview img:hover {
            transform: scale(1.05);
        }

        .image-count-badge {
            position: absolute;
            bottom: 4px;
            right: 4px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .image-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 103;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .image-modal-content {
            max-width: 90%;
            max-height: 90%;
        }

        .image-modal-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            z-index: 1;
        }

        .image-modal-prev {
            left: 20px;
        }

        .image-modal-next {
            right: 20px;
        }

        .image-modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            z-index: 1;
        }

        /* Dark mode aware */
        @media (prefers-color-scheme: dark) {
            :root {
                --tg-bg-color: #18222d;
                --tg-secondary-bg-color: #1e2733;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Rest of the component template -->
    </div>

    <script>
        // –°–æ–∑–¥–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç context
        const context = {
            user_data: null
        };
        
        const { createApp, ref, computed, onMounted, nextTick } = Vue;
        
        createApp({
            setup() {
                // View states
                const currentView = ref('main');
                const currentTab = ref('active');
                const isLoading = ref(true);
                const activeModal = ref(null);
                const showNotification = ref(false);
                const confirmationMessage = ref('');
                const confirmationDetails = ref('');
                const pendingConfirmationAction = ref(() => {});
                const notificationMessage = ref('');
                const notificationIcon = ref('');
                const colorScheme = ref('dark');
                
                // Image viewer
                const imageViewer = ref({
                    open: false,
                    images: [],
                    currentIndex: 0
                });
                
                // Telegram WebApp integration
                const WebApp = window.Telegram.WebApp;
                const initData = WebApp.initData || '';
                const initDataUnsafe = WebApp.initDataUnsafe || {};
                
                // Data
                const selectedGroup = ref('');
                const botGroups = ['9–ò–°–ü-12–ö-24', '9–ö–°–ö-10-24', '9–ò–°–ü-111–ö-24', '9–ò–ö–°–°-13-24'];
                const ADMIN_KEY = 'admin123'; // –ó–¥–µ—Å—å —É–∫–∞–∂–∏—Ç–µ –≤–∞—à –∫–ª—é—á –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
                const isAdmin = ref(localStorage.getItem('isAdmin') === 'true');
                const adminKeyInput = ref('');
                
                const botSubjects = [
                    { id: 1, name: '–ë–∞—à–∫–∏—Ä—Å–∫–∏–π —è–∑—ã–∫', emoji: 'üìö' },
                    { id: 2, name: '–ë–∏–æ–ª–æ–≥–∏—è', emoji: 'üß¨' },
                    { id: 3, name: '–ì–µ–æ–≥—Ä–∞—Ñ–∏—è', emoji: 'üåç' },
                    { id: 4, name: '–ò–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã–π —è–∑—ã–∫', emoji: 'üåê' },
                    { id: 5, name: '–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞', emoji: 'üíª' },
                    { id: 6, name: '–ò—Å—Ç–æ—Ä–∏—è', emoji: 'üìú' },
                    { id: 7, name: '–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞', emoji: 'üìñ' },
                    { id: 8, name: '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', emoji: 'üî¢' },
                    { id: 9, name: '–û–±—â–µ—Å—Ç–≤–æ–∑–Ω–∞–Ω–∏–µ: –ø—Ä–∞–≤–æ', emoji: '‚öñÔ∏è' },
                    { id: 10, name: '–û–±—â–µ—Å—Ç–≤–æ–∑–Ω–∞–Ω–∏–µ: —ç–∫–æ–Ω–æ–º–∏–∫–∞', emoji: 'üìä' },
                    { id: 11, name: '–û—Å–Ω–æ–≤—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ –∑–∞—â–∏—Ç—ã –†–æ–¥–∏–Ω—ã', emoji: 'üõ°Ô∏è' },
                    { id: 12, name: '–†—É—Å—Å–∫–∏–π —è–∑—ã–∫', emoji: '‚úçÔ∏è' },
                    { id: 13, name: '–§–∏–∑–∏–∫–∞', emoji: '‚ö°' },
                    { id: 14, name: '–§–∏–∑–∏—á–µ—Å–∫–∞—è –∫—É–ª—å—Ç—É—Ä–∞', emoji: 'üèÉ' },
                    { id: 15, name: '–•–∏–º–∏—è', emoji: 'üß™' }
                ];
                
                const subjects = ref([...botSubjects]);
                
                const newSubject = ref({
                    name: '',
                    emoji: '',
                    group: ''
                });
                
                const currentSubject = ref({});
                const currentAssignment = ref({});
                
                const assignments = ref([
                    {
                        id: 1,
                        subject: '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', 
                        subjectId: 8,
                        group: '9–ò–°–ü-12–ö-24',
                        description: '–†–µ—à–∏—Ç—å –∑–∞–¥–∞—á–∏ ‚Ññ45-50 –∏–∑ —É—á–µ–±–Ω–∏–∫–∞, —Å—Ç—Ä–∞–Ω–∏—Ü–∞ 123. –û—Å–æ–±–æ–µ –≤–Ω–∏–º–∞–Ω–∏–µ —É–¥–µ–ª–∏—Ç—å –∑–∞–¥–∞—á–µ ‚Ññ48, —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∞ –±—É–¥–µ—Ç –Ω–∞ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–π.',
                        status: 'new',
                        assignedDate: new Date(),
                        dueDate: new Date(Date.now() + 86400000 * 3), // 3 days from now
                        files: [
                            { id: 1, name: 'photo1.jpg', size: 1245000, preview: 'https://picsum.photos/200/300?random=1' },
                            { id: 2, name: 'example.png', size: 654321, preview: 'https://picsum.photos/200/300?random=2' },
                            { id: 3, name: '–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã.pdf', size: 2345678 },
                            { id: 4, name: 'diagram.jpg', size: 456789, preview: 'https://picsum.photos/200/300?random=3' }
                        ],
                        studentFiles: []
                    },
                    {
                        id: 2, 
                        subject: '–†—É—Å—Å–∫–∏–π —è–∑—ã–∫',
                        subjectId: 12,
                        group: '9–ò–°–ü-12–ö-24',
                        description: '–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ—á–∏–Ω–µ–Ω–∏–µ –Ω–∞ —Ç–µ–º—É "–ú–æ–µ –æ—Ç–Ω–æ—à–µ–Ω–∏–µ –∫ –∏—Å–∫—É—Å—Å—Ç–≤—É". –û–±—ä–µ–º - 3 —Å—Ç—Ä–∞–Ω–∏—Ü—ã, —Å–¥–∞—Ç—å –¥–æ —Å–ª–µ–¥—É—é—â–µ–π —Å—Ä–µ–¥—ã.',
                        status: 'viewed',
                        assignedDate: new Date(Date.now() - 86400000 * 2),
                        dueDate: new Date(Date.now() + 86400000 * 5),
                        files: [
                            { id: 5, name: 'textbook-page.jpg', size: 765432, preview: 'https://picsum.photos/200/300?random=4' }
                        ],
                        studentFiles: []
                    },
                    {
                        id: 3,
                        subject: '–§–∏–∑–∏–∫–∞',
                        subjectId: 13,
                        group: '9–ò–°–ü-12–ö-24',
                        description: '–ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—é –æ –∑–∞–∫–æ–Ω–∞—Ö —Ç–µ—Ä–º–æ–¥–∏–Ω–∞–º–∏–∫–∏. –ú–∏–Ω–∏–º—É–º 10 —Å–ª–∞–π–¥–æ–≤ —Å –∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏—è–º–∏.',
                        status: 'completed',
                        assignedDate: new Date(Date.now() - 86400000 * 4),
                        dueDate: new Date(Date.now() - 86400000),
                        files: [
                            { id: 6, name: '–ú–µ—Ç–æ–¥–∏—á–∫–∞ –ø–æ —Ç–µ—Ä–º–æ–¥–∏–Ω–∞–º–∏–∫–µ.pdf', size: 2345678 }
                        ],
                        studentFiles: [
                            { id: 1, name: '–ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è.pptx', size: 3456789, uploadDate: new Date(Date.now() - 86400000 * 2) }
                        ]
                    },
                    {
                        id: 4,
                        subject: '–ò—Å—Ç–æ—Ä–∏—è',
                        subjectId: 6,
                        group: '9–ò–°–ü-12–ö-24',
                        description: '–ü—Ä–æ—á–∏—Ç–∞—Ç—å –≥–ª–∞–≤—É 5 —É—á–µ–±–Ω–∏–∫–∞ –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –∫—Ä–∞—Ç–∫–∏–π –∫–æ–Ω—Å–ø–µ–∫—Ç',
                        status: 'new',
                        assignedDate: new Date(),
                        dueDate: null,
                        files: [
                            { id: 7, name: 'historical-image.jpg', size: 1234567, preview: 'https://picsum.photos/200/300?random=5' },
                            { id: 8, name: 'textbook-chapter.pdf', size: 2345678 }
                        ],
                        studentFiles: []
                    },
                    {
                        id: 5,
                        subject: '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞',
                        subjectId: 8,
                        group: '9–ò–°–ü-12–ö-24',
                        description: '–†–µ—à–∏—Ç—å –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—É—é —Ä–∞–±–æ—Ç—É –∏–∑ —Å–±–æ—Ä–Ω–∏–∫–∞. –í–∞—Ä–∏–∞–Ω—Ç 11–ê.',
                        status: 'archived',
                        assignedDate: new Date(Date.now() - 86400000 * 10),
                        archivedDate: new Date(Date.now() - 86400000 * 7),
                        files: [
                            { id: 9, name: '–ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞.pdf', size: 765432 },
                            { id: 10, name: 'problem1.jpg', size: 654321, preview: 'https://picsum.photos/200/300?random=6' },
                            { id: 11, name: 'problem2.jpg', size: 543210, preview: 'https://picsum.photos/200/300?random=7' }
                        ],
                        studentFiles: [
                            { id: 2, name: '–ú–æ—è –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è.pdf', size: 654321, uploadDate: new Date(Date.now() - 86400000 * 8) }
                        ]
                    }
                ]);
                
                const newAssignment = ref({
                    subject: '',
                    subjectId: null,
                    group: '',
                    description: '',
                    files: [],
                    dueDate: null
                });
                
                const uploadedFiles = ref([]);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
                const newGroupName = ref('');
                
                // Computed properties
                const filteredSubjects = computed(() => {
                    return subjects.value.filter(subj => 
                        subj.group === undefined || 
                        subj.group === '' || 
                        subj.group === selectedGroup.value
                    );
                });
                
                const filteredActiveAssignments = computed(() => {
                    return assignments.value.filter(a => 
                        a.subjectId === currentSubject.value.id && 
                        a.group === selectedGroup.value && 
                        a.status !== 'archived'
                    ).sort((a, b) => new Date(b.assignedDate) - new Date(a.assignedDate));
                });
                
                const filteredArchivedAssignments = computed(() => {
                    return assignments.value.filter(a => 
                        a.subjectId === currentSubject.value.id && 
                        a.group === selectedGroup.value && 
                        a.status === 'archived'
                    ).sort((a, b) => new Date(b.archivedDate) - new Date(a.archivedDate));
                });
                
                // Methods
                const isImageFile = (filename) => {
                    if (!filename) return false;
                    const imgExtensions = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp'];
                    const ext = filename.split('.').pop().toLowerCase();
                    return imgExtensions.includes(ext);
                };
                
                const hasImageAttachments = (assignment) => {
                    return assignment.files.some(file => isImageFile(file.name));
                };
                
                const hasNonImageAttachments = (assignment) => {
                    return assignment.files.some(file => !isImageFile(file.name));
                };
                
                const getImageAttachments = (assignment) => {
                    return assignment.files.filter(file => isImageFile(file.name));
                };
                
                const openImageGallery = (images, startIndex = 0) => {
                    imageViewer.value = {
                        open: true,
                        images: images.map(img => img.preview),
                        currentIndex: startIndex
                    };
                };
                
                const closeImageViewer = () => {
                    imageViewer.value.open = false;
                };
                
                const nextImage = () => {
                    if (imageViewer.value.currentIndex < imageViewer.value.images.length - 1) {
                        imageViewer.value.currentIndex++;
                    }
                };
                
                const prevImage = () => {
                    if (imageViewer.value.currentIndex > 0) {
                        imageViewer.value.currentIndex--;
                    }
                };
                
                const isOverdue = (assignment) => {
                    if (!assignment.dueDate) return false;
                    return new Date(assignment.dueDate) < new Date() && assignment.status !== 'completed';
                };
                
                const formatDate = (date) => {
                    if (!date) return '–ë–µ–∑ —Å—Ä–æ–∫–∞';
                    const d = new Date(date);
                    const options = { day: 'numeric', month: 'long', year: 'numeric' };
                    return d.toLocaleDateString('ru-RU', options);
                };
                
                const formatDateTime = (date) => {
                    if (!date) return '';
                    const d = new Date(date);
                    return d.toLocaleString('ru-RU');
                };
                
                const formatFileSize = (bytes) => {
                    if (bytes === 0) return '0 –±–∞–π—Ç';
                    const sizes = ['–±–∞–π—Ç', '–ö–ë', '–ú–ë', '–ì–ë'];
                    const i = Math.floor(Math.log(bytes) / Math.log(1024));
                    return parseFloat((bytes / Math.pow(1024, i)).toFixed(2)) + ' ' + sizes[i];
                };
                
                const getPendingCount = (group, subjectId) => {
                    return assignments.value.filter(a => 
                        a.group === group && 
                        a.subjectId === subjectId && 
                        (a.status === 'new' || a.status === 'viewed')
                    ).length;
                };
                
                const getArchivedCount = (group, subjectName) => {
                    return assignments.value.filter(a => 
                        a.group === group && 
                        a.subject === subjectName && 
                        a.status === 'archived'
                    ).length;
                };
                
                // Telegram WebApp methods
                const initTelegramWebApp = () => {
                    try {
                        // –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ URL
                        const urlParams = new URLSearchParams(window.location.search);
                        const isAllowed = urlParams.get('allowed') === 'true';
                        const username = urlParams.get('username');
                        
                        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                        context.user_data = {
                            isAllowed: isAllowed,
                            username: username
                        };
                        
                    if (WebApp) {
                        // Expand app to full viewport
                        WebApp.expand();
                        
                        // Set theme colors
                        colorScheme.value = WebApp.colorScheme || 'dark';
                        WebApp.setBackgroundColor('#17212b');
                        WebApp.setHeaderColor('#2b3647');
                        }
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥—Ä—É–ø–ø—É
                        const savedGroup = localStorage.getItem('selectedGroup');
                        if (savedGroup && botGroups.includes(savedGroup)) {
                            selectedGroup.value = savedGroup;
                        } else if (urlParams.has('group')) {
                            const groupParam = urlParams.get('group');
                            if (botGroups.includes(groupParam)) {
                                selectedGroup.value = groupParam;
                                localStorage.setItem('selectedGroup', groupParam);
                            } else {
                                selectedGroup.value = botGroups[0];
                                localStorage.setItem('selectedGroup', botGroups[0]);
                            }
                        } else {
                            selectedGroup.value = botGroups[0];
                            localStorage.setItem('selectedGroup', botGroups[0]);
                        }
                        
                        // –£–±–∏—Ä–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
                    isLoading.value = false;
                    } catch (error) {
                        console.error('Error initializing WebApp:', error);
                        // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –≤—Å–µ —Ä–∞–≤–Ω–æ —É–±–∏—Ä–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
                        isLoading.value = false;
                    }
                };
                
                const openFile = (file) => {
                    if (WebApp) {
                        // In Telegram WebApp, we can't open files directly
                        // So we'll just show a notification
                        showNotice('–û—Ç–∫—Ä—ã—Ç–∏–µ —Ñ–∞–π–ª–æ–≤ –¥–æ—Å—Ç—É–ø–Ω–æ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –∫–ª–∏–µ–Ω—Ç–µ Telegram', 'fas fa-info-circle');
                    } else {
                        // Fallback for local development
                        window.open(`#${file.id}`, '_blank');
                    }
                };
                
                const sendDataToBot = (action, data) => {
                    if (WebApp) {
                        WebApp.sendData(JSON.stringify({ action, data }));
                    } else {
                        console.log('Data sent to bot:', { action, data });
                        // Simulate response in development
                        setTimeout(() => {
                            showNotice('–î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ Telegram –±–æ—Ç', 'fas fa-paper-plane');
                        }, 500);
                    }
                };
                
                // Modal methods
                const toggleGroupSelect = () => {
                    activeModal.value = activeModal.value === 'group-select' ? null : 'group-select';
                };
                
                const showAddAssignmentModal = () => {
                    if (!checkPermissions()) return;
                    newAssignment.value.subject = currentSubject.value.name;
                    newAssignment.value.subjectId = currentSubject.value.id;
                    newAssignment.value.group = selectedGroup.value;
                    activeModal.value = 'add-assignment';
                };
                
                const showUploadModal = () => {
                    if (!checkPermissions()) return;
                    uploadedFiles.value = [];
                    activeModal.value = 'file-upload';
                };
                
                const showAddSubjectModal = () => {
                    newSubject.value.group = selectedGroup.value;
                    activeModal.value = 'add-subject';
                };
                
                const showConfirmationModal = (message, details, action) => {
                    confirmationMessage.value = message;
                    confirmationDetails.value = details;
                    pendingConfirmationAction.value = action;
                    activeModal.value = 'confirmation';
                };
                
                const showArchiveConfirmation = () => {
                    showConfirmationModal(
                        '–ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ?',
                        '–ó–∞–¥–∞–Ω–∏–µ –±—É–¥–µ—Ç –ø–µ—Ä–µ–º–µ—â–µ–Ω–æ –≤ –∞—Ä—Ö–∏–≤ –∏ —Å–∫—Ä—ã—Ç–æ –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞.',
                        () => {
                            currentAssignment.value.status = 'archived';
                            currentAssignment.value.archivedDate = new Date();
                            sendDataToBot('archive_assignment', { id: currentAssignment.value.id });
                            currentView.value = 'assignments';
                            showNotice('–ó–∞–¥–∞–Ω–∏–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–æ –≤ –∞—Ä—Ö–∏–≤', 'fas fa-archive');
                        }
                    );
                };
                
                const executeConfirmationAction = () => {
                    pendingConfirmationAction.value();
                    closeModal();
                };
                
                const closeModal = () => {
                    activeModal.value = null;
                };
                
                // Other methods
                const selectGroup = (group) => {
                    selectedGroup.value = group;
                    localStorage.setItem('selectedGroup', group); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –≥—Ä—É–ø–ø—É
                    sendDataToBot('select_group', { group });
                    closeModal();
                    showNotice('–ì—Ä—É–ø–ø–∞ –∏–∑–º–µ–Ω–µ–Ω–∞ –Ω–∞ ' + group, 'fas fa-check-circle');
                };
                
                const viewAssignments = (subject) => {
                    currentSubject.value = subject;
                    currentView.value = 'assignments';
                    currentTab.value = 'active';
                };
                
                const viewAssignmentDetails = (assignment) => {
                    // Mark as viewed if status is "new"
                    if (assignment.status === 'new') {
                        assignment.status = 'viewed';
                        sendDataToBot('view_assignment', { id: assignment.id });
                    }
                    
                    currentAssignment.value = assignment;
                    currentView.value = 'assignment-details';
                };
                
                const markAsCompleted = () => {
                    currentAssignment.value.status = 'completed';
                    sendDataToBot('complete_assignment', { id: currentAssignment.value.id });
                    showNotice('–ó–∞–¥–∞–Ω–∏–µ –æ—Ç–º–µ—á–µ–Ω–æ –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–µ', 'fas fa-check-circle');
                };
                
                const uncompleteAssignment = () => {
                    currentAssignment.value.status = 'viewed';
                    sendDataToBot('uncomplete_assignment', { id: currentAssignment.value.id });
                    showNotice('–ó–∞–¥–∞–Ω–∏–µ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–æ –≤ —Ä–∞–±–æ—Ç—É', 'fas fa-undo');
                };
                
                const archiveAssignment = () => {
                    if (!checkPermissions()) return;
                    
                    currentAssignment.value.status = 'archived';
                    currentAssignment.value.archivedDate = new Date();
                    sendDataToBot('archive_assignment', { id: currentAssignment.value.id });
                    currentView.value = 'assignments';
                    showNotice('–ó–∞–¥–∞–Ω–∏–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–æ –≤ –∞—Ä—Ö–∏–≤', 'fas fa-archive');
                };
                
                const unarchiveAssignment = () => {
                    currentAssignment.value.status = 'viewed';
                    sendDataToBot('unarchive_assignment', { id: currentAssignment.value.id });
                    currentView.value = 'assignments';
                    showNotice('–ó–∞–¥–∞–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∏–∑ –∞—Ä—Ö–∏–≤–∞', 'fas fa-box-open');
                };
                
                const triggerFileInput = () => {
                    const fileInput = document.querySelector('input[type="file"]');
                    if (fileInput) fileInput.click();
                };
                
                const handleFileUpload = (event) => {
                    const files = Array.from(event.target.files || []);
                    files.forEach(file => {
                        const reader = new FileReader();
                        if (isImageFile(file.name)) {
                            reader.onload = (e) => {
                                uploadedFiles.value.push({
                                    id: Date.now() + Math.random().toString(36).substring(2),
                                    name: file.name,
                                    size: file.size,
                                    preview: e.target.result
                                });
                            };
                            reader.readAsDataURL(file);
                        } else {
                            uploadedFiles.value.push({
                                id: Date.now() + Math.random().toString(36).substring(2),
                                name: file.name,
                                size: file.size
                            });
                        }
                    });
                };
                
                const removeFile = (index) => {
                    uploadedFiles.value.splice(index, 1);
                };
                
                const submitSolution = () => {
                    if (!checkPermissions()) return;
                    
                    // Add uploaded files to the assignment
                    uploadedFiles.value.forEach(file => {
                        currentAssignment.value.studentFiles.push({
                            ...file,
                            uploadDate: new Date()
                        });
                    });
                    
                    sendDataToBot('upload_solution', {
                        assignmentId: currentAssignment.value.id,
                        files: uploadedFiles.value
                    });
                    
                    uploadedFiles.value = [];
                    closeModal();
                    showNotice('–†–µ—à–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ', 'fas fa-check-circle');
                };
                
                const createAssignment = async () => {
                    if (!checkPermissions()) return;
                    
                    const currentFiles = [...newAssignment.value.files];
                    
                    const newAssignmentObj = {
                        id: Date.now(),
                        subject: currentSubject.value.name,
                        subjectId: currentSubject.value.id,
                        group: selectedGroup.value,
                        description: newAssignment.value.description,
                        status: 'new',
                        assignedDate: new Date(),
                        dueDate: newAssignment.value.dueDate ? new Date(newAssignment.value.dueDate) : null,
                        files: currentFiles,
                        studentFiles: []
                    };
                    
                    assignments.value.unshift(newAssignmentObj);
                    sendDataToBot('create_assignment', newAssignmentObj);
                    
                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è —Ñ–æ—Ä–º—ã
                    Object.assign(newAssignment.value, {
                        subject: '',
                        subjectId: null,
                        group: '',
                        description: '',
                        files: [],
                        dueDate: null
                    });
                    
                    // –§–æ—Ä—Å–∏—Ä—É–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ DOM –ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º
                    await nextTick();
                    
                    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞–ø—Ä—è–º—É—é
                    const modalElement = document.querySelector('.modal-content');
                    if (modalElement) {
                        modalElement.style.display = 'none';
                    }
                    
                    activeModal.value = null;
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                    showNotice('–ù–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ', 'fas fa-check-circle');
                };
                
                const triggerAssignmentFileInput = () => {
                    const fileInput = document.querySelector('input[type="file"]');
                    if (fileInput) fileInput.click();
                };
                
                const handleAssignmentFileUpload = (event) => {
                    const files = Array.from(event.target.files || []);
                    const promises = files.map(file => {
                        return new Promise((resolve) => {
                            if (isImageFile(file.name)) {
                                const reader = new FileReader();
                                reader.onload = (e) => {
                                    resolve({
                                        id: Date.now() + Math.random().toString(36).substring(2),
                                        name: file.name,
                                        size: file.size,
                                        preview: e.target.result
                                    });
                                };
                                reader.readAsDataURL(file);
                            } else {
                                resolve({
                                    id: Date.now() + Math.random().toString(36).substring(2),
                                    name: file.name,
                                    size: file.size
                                });
                            }
                        });
                    });

                    Promise.all(promises).then(files => {
                        newAssignment.value.files.push(...files);
                    });
                };
                
                const removeAssignmentFile = (index) => {
                    newAssignment.value.files.splice(index, 1);
                };
                
                const addSubject = () => {
                    const newSubjectObj = {
                        id: Date.now(),
                        name: newSubject.value.name,
                        emoji: newSubject.value.emoji,
                        group: newSubject.value.group || selectedGroup.value
                    };
                    
                    subjects.value.push(newSubjectObj);
                    
                    // Reset form
                    newSubject.value = {
                        name: '',
                        emoji: '',
                        group: ''
                    };
                    
                    sendDataToBot('add_subject', newSubjectObj);
                    
                    closeModal();
                    showNotice('–ù–æ–≤—ã–π –ø—Ä–µ–¥–º–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω', 'fas fa-check-circle');
                };
                
                const showNotice = (message, icon) => {
                    notificationMessage.value = message;
                    notificationIcon.value = icon;
                    showNotification.value = true;
                    
                    setTimeout(() => {
                        showNotification.value = false;
                    }, 3000);
                };
                
                const viewArchivedSubjects = () => {
                    showNotice('–§—É–Ω–∫—Ü–∏—è –∞—Ä—Ö–∏–≤–∞ –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'fas fa-cogs');
                };
                
                // –¢–∞–∫–∂–µ –¥–æ–±–∞–≤—å—Ç–µ –º–µ—Ç–æ–¥ –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
                const forceCloseModal = () => {
                    activeModal.value = null;
                    const modalElement = document.querySelector('.modal-content');
                    if (modalElement) {
                        modalElement.style.display = 'none';
                    }
                };
                
                // –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–æ–¥ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤
                const checkPermissions = () => {
                    if (!isAdmin.value) {
                        showNotice('–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞–Ω–∏–π', 'fas fa-exclamation-circle');
                        return false;
                    }
                    return true;
                };
                
                // Admin methods
                const showAdminKeyModal = () => {
                    activeModal.value = 'admin-key';
                };

                const submitAdminKey = () => {
                    if (adminKeyInput.value === ADMIN_KEY) {
                        isAdmin.value = true;
                        localStorage.setItem('isAdmin', 'true');
                        showNotice('–ü—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –ø–æ–ª—É—á–µ–Ω—ã', 'fas fa-check-circle');
                        closeModal();
                    } else {
                        showNotice('–ù–µ–≤–µ—Ä–Ω—ã–π –∫–ª—é—á –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞', 'fas fa-exclamation-circle');
                    }
                    adminKeyInput.value = '';
                };

                const removeAdminRights = () => {
                    isAdmin.value = false;
                    localStorage.removeItem('isAdmin');
                    showNotice('–ü—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ —É–¥–∞–ª–µ–Ω—ã', 'fas fa-user-slash');
                    closeModal();
                };
                
                // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –º–µ—Ç–æ–¥—ã
                const showManageGroupsModal = () => {
                    if (!isAdmin.value) {
                        showNotice('–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≥—Ä—É–ø–ø–∞–º–∏', 'fas fa-exclamation-circle');
                        return;
                    }
                    activeModal.value = 'manage-groups';
                };

                const addNewGroup = () => {
                    if (!newGroupName.value.trim()) return;
                    
                    if (botGroups.includes(newGroupName.value.trim())) {
                        showNotice('–¢–∞–∫–∞—è –≥—Ä—É–ø–ø–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç', 'fas fa-exclamation-circle');
                        return;
                    }

                    botGroups.push(newGroupName.value.trim());
                    showNotice('–ì—Ä—É–ø–ø–∞ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞', 'fas fa-check-circle');
                    newGroupName.value = '';
                };

                const confirmDeleteGroup = (group) => {
                    showConfirmationModal(
                        '–£–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É?',
                        `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É "${group}"? –í—Å–µ –¥–∞–Ω–Ω—ã–µ –≥—Ä—É–ø–ø—ã –±—É–¥—É—Ç –ø–æ—Ç–µ—Ä—è–Ω—ã.`,
                        () => deleteGroup(group)
                    );
                };

                const deleteGroup = (group) => {
                    const groups = botGroups.filter(g => g !== group);
                    botGroups.value = groups;
                    
                    // –ï—Å–ª–∏ —É–¥–∞–ª—è–µ–º —Ç–µ–∫—É—â—É—é –≥—Ä—É–ø–ø—É, –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –ø–µ—Ä–≤—É—é –¥–æ—Å—Ç—É–ø–Ω—É—é
                    if (selectedGroup.value === group && groups.length > 0) {
                        selectedGroup.value = groups[0];
                    }
                    
                    showNotice('–ì—Ä—É–ø–ø–∞ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞', 'fas fa-check-circle');
                };
                
                // Initialize
                onMounted(() => {
                    initTelegramWebApp();
                });
                
                // –¢–∞–∫–∂–µ –Ω—É–∂–Ω–æ —Å–∫—Ä—ã—Ç—å –∫–Ω–æ–ø–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –±–µ–∑ –ø—Ä–∞–≤
                const showActionButtons = computed(() => {
                    return isAdmin.value === true;
                });
                
                return {
                    // States
                    currentView,
                    currentTab,
                    isLoading,
                    activeModal,
                    showNotification,
                    confirmationMessage,
                    confirmationDetails,
                    notificationMessage,
                    notificationIcon,
                    imageViewer,
                    isAdmin,
                    adminKeyInput,
                    
                    // Data
                    selectedGroup,
                    botGroups,
                    subjects,
                    filteredSubjects,
                    newSubject,
                    currentSubject,
                    currentAssignment,
                    assignments,
                    newAssignment,
                    uploadedFiles,
                    newGroupName,
                    
                    // Computed properties
                    filteredActiveAssignments,
                    filteredArchivedAssignments,
                    showActionButtons,
                    
                    // Methods
                    isOverdue,
                    formatDate,
                    formatDateTime,
                    formatFileSize,
                    getPendingCount,
                    getArchivedCount,
                    toggleGroupSelect,
                    selectGroup,
                    viewAssignments,
                    viewAssignmentDetails,
                    markAsCompleted,
                    uncompleteAssignment,
                    archiveAssignment,
                    unarchiveAssignment,
                    openFile,
                    triggerFileInput,
                    handleFileUpload,
                    removeFile,
                    submitSolution,
                    createAssignment,
                    triggerAssignmentFileInput,
                    handleAssignmentFileUpload,
                    removeAssignmentFile,
                    showAddSubjectModal,
                    addSubject,
                    viewArchivedSubjects,
                    showConfirmationModal,
                    showArchiveConfirmation,
                    executeConfirmationAction,
                    closeModal,
                    showAddAssignmentModal,
                    showUploadModal,
                    isImageFile,
                    hasImageAttachments,
                    hasNonImageAttachments,
                    getImageAttachments,
                    openImageGallery,
                    closeImageViewer,
                    nextImage,
                    prevImage,
                    forceCloseModal,
                    checkPermissions,
                    showAdminKeyModal,
                    submitAdminKey,
                    removeAdminRights,
                    showManageGroupsModal,
                    addNewGroup,
                    confirmDeleteGroup
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
